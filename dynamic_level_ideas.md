# 动态关卡机制初步想法 (基于回合数)

## 核心目标

通过引入基于玩家放置方块次数（回合数）的动态难度调整和周期性挑战，提升游戏的节奏感、爽快感和长期可玩性，替代当前相对平稳的游戏进程。爽感的营造不仅依赖于难度降低，更要通过**惊喜解围、布局引导、危机化解和强化反馈**来实现，并保证玩家的成功主要源于对标准方块的运用技巧。

## 机制设计：节奏波

游戏节奏围绕"回合数"（成功放置一个方块计为 1 回合）展开，并在不同阶段间周期性切换，形成"节奏波"。

### 1. 回合计数器

-   在 `Game` 结构体中添加 `turn_count: u32` 字段。
-   每次成功放置方块后，`turn_count += 1`。

### 2. 基础难度演进

-   游戏的基础难度随 `turn_count` 增加而缓慢提升。
-   提升方式：调整方块生成的复杂度因子 (`block_complexity_factor`)，该因子会影响从不同方块池（EASY, NORMAL, HAPPY）中选择方块的概率，间接影响方块的复杂程度。
-   方块生成的数量目前固定为3。

### 3. 波次阶段与转换 (基于回合)

游戏在以下阶段间循环切换，由 `WaveManager` 根据其内部的回合计数器和各阶段配置的持续回合数触发：

-   **积累阶段 (波谷):**
    -   难度相对平稳或略低，方块复杂度较低。
    -   目标：让玩家清理棋盘、积累分数/连击、建立信心。
    -   **惊喜解围机制 (初步实现):**
        -   `Grid` 模块现在可以分析棋盘，找出接近完成的行/列 (例如只差1或2格)，并计算棋盘的整体填充比例。
        -   `WaveManager` 会根据当前阶段 (Accumulation) 和棋盘填充率 (例如，当棋盘很满时)，以一定概率决定是否提供"帮助性"方块。
        -   如果决定提供帮助，`Game::generate_blocks` 会尝试调用 `Grid::find_placeable_shapes_for_empty_spots` 来寻找可以放置的、能填补1格或2格空缺的小方块 (如1x1的点或1x2的条，包括其旋转形态)。
        -   如果找到这样的"有用方块"，会将其加入到待选方块列表中，替换掉一个普通生成的方块。
    -   **(新增) 引导连消布局 (待实现):**
        -   *方块组合设计:* 生成的方块组在形状上倾向于可以互相配合、嵌套或轻松排列以消除多行/列。
        -   *"暗示性"生成:* 引导玩家发现多行消除的可能性。

-   **挑战阶段 (波峰):**
    -   难度显著提升，方块复杂度因子增加，持续固定回合数。
    -   **挑战类型 (目前仅有 `BlockFlood`):**
        -   **方块潮 (`BlockFlood`):** 方块复杂度因子显著提高。
    -   目标：考验玩家的空间管理、快速决策和消除技巧。

-   **缓和阶段 (Relief):**
    -   挑战结束后，难度暂时回落，方块复杂度因子降低，持续少量回合。
    -   目标：给玩家喘息和整理棋盘的时间。
    -   **惊喜解围机制 (同积累阶段):** 在此阶段，`WaveManager` 提供"帮助性"方块的概率会更高。

-   **下一轮积累:**
    -   进入新的循环，基础难度可能略高于上一轮。

### 4. 提升"爽感"的要点 (贯穿各阶段)

-   **惊喜与解围:** 利用情景感知生成（当前为可放置的1x1或1x2标准方块）创造"柳暗花明"的时刻。
-   **布局引导与成就 (待实现):** 通过巧妙的标准方块组合让玩家更容易打出高连击/多行消除，获得掌控感和成就感。
-   **危机化解:** 在高压下成功消除（尤其是在挑战阶段或棋盘将满时）带来极大的满足感和放松感。可加入"极限操作"奖励。
-   **强化反馈机制 (部分实现，待增强):**
    -   *连击反馈:* 阶梯式增强的视听效果，可加入屏幕震动或强调效果。
    -   *多行/列消除反馈:* 触发远超单消的、独特的、更震撼的庆祝视听效果。
    -   *(可选)* 细微的"完美放置"提示，鼓励并奖励最优策略。

## 实现考量

-   `Game` 结构体已包含 `turn_count` (通过 `WaveManager` 间接管理) 和 `WaveManager` 实例。
-   `WaveManager` (`wave.rs`) 管理 `WavePhase` 枚举、阶段转换、回合计数、难度参数 (`block_complexity_factor`)。挑战类型目前固定为 `BlockFlood`。
    -   新增 `should_offer_helpful_block(grid_filled_ratio: f32) -> bool` 方法用于判断是否提供帮助方块。
-   `update_game` 在成功放置方块后调用 `wave_manager.increment_turn()`。
-   `generate_blocks` (`main.rs`) 根据 `WaveManager` 的状态和 `Grid` 的分析结果调整方块生成：
    -   调用 `grid.find_placeable_shapes_for_empty_spots()` 寻找有用的小方块。
    -   其余方块使用 `block::BlockShape::generate_with_complexity()`。
-   `grid.rs`:
    -   新增 `get_almost_complete_lines()` 和 `get_filled_ratio()` 用于棋盘分析。
    -   新增 `find_placeable_shapes_for_empty_spots()` 用于查找可放置的小型"有用方块"。
-   `block.rs`:
    -   新增 `BlockShape::new_dot()` 用于直接创建1x1方块。
    -   `rotate_90_clockwise`, `normalize_cells`, `get_random_block_color` 已设为 `pub`。
    -   `SHAPE_DOT`, `SHAPE_H2` 已设为 `pub const`。
-   `draw_game` 已添加反映当前波次阶段的文本 (目前挑战阶段仅显示为 "方块潮")。
-   `effects.rs` 提供视觉特效，未来可增强。
-   音效系统待集成。 