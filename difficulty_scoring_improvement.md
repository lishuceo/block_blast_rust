# 困难度评分系统改进

## 问题分析

用户反馈整局游戏没有触发一次帮助功能，日志显示 `difficulty_score` 一直很低。经过分析发现原有困难度评分系统存在以下问题：

1. **阈值过于严格**：只有当最大连通区域小于4个格子时才会显著增加困难度
2. **对早期游戏不敏感**：游戏开始时空白区域很大，困难度分数接近0
3. **忽略了填充率因素**：没有考虑整体空白格子的占比

## 改进方案

### 1. 调整 `get_difficulty_score` 函数（grid.rs）

#### 最大连通区域大小评分
- 原阈值：<4 (+0.4), <8 (+0.25), <16 (+0.1)
- 新阈值：<6 (+0.4), <12 (+0.25), <20 (+0.15), <30 (+0.08)
- 效果：更早地识别出中等困难的情况

#### 新增空白格子占比因素
```rust
let empty_ratio = total_empty_cells as f32 / 64.0;
if empty_ratio < 0.3 {
    difficulty += 0.15; // 空白格子少于30%时增加困难度
} else if empty_ratio < 0.5 {
    difficulty += 0.08; // 空白格子少于50%时轻微增加困难度
}
```

#### 调整权重分配
- 碎片化程度权重：0.2 → 0.35（提高）
- 形状分数权重：0.3/0.15 → 0.25/0.12（降低）
- 无4x4空间权重：0.2 → 0.15（降低）

### 2. 调整 `should_offer_helpful_block_v2` 函数（wave.rs）

降低了所有阶段的触发阈值，使帮助功能更容易被触发：

#### 缓和阶段
- 原阈值：0.7/0.5/0.3
- 新阈值：0.5/0.35/0.2/0.1
- 新增了更多档位，即使困难度很低也有小概率获得帮助

#### 积累阶段
- 原阈值：0.8/0.6/0.4/0.25
- 新阈值：0.6/0.45/0.3/0.15/0.05
- 更细化的分级，使帮助触发更加平滑

#### 挑战阶段
- 原阈值：0.85/0.7/0.5
- 新阈值：0.7/0.55/0.4/0.25
- 保持较高门槛但适当降低，确保极度困难时仍能获得帮助

## 预期效果

1. **更合理的困难度评估**：游戏中期（空白格子30-50%）就能产生0.2-0.4的困难度分数
2. **更频繁的帮助触发**：在积累阶段，当困难度达到0.15时就有30%概率获得帮助
3. **更平滑的游戏体验**：避免突然死亡，在困难增加时逐步提供帮助

## 调试建议

通过日志输出可以观察：
- `difficulty_score`：现在应该在0.1-0.6之间变化（游戏中期）
- `offer_help`：应该在游戏进行到一定程度后开始出现true
- 区域详情：可以看到最大连通区域大小、形状分数、碎片化程度等详细信息

## 后续优化方向

1. 可以考虑加入更多因素，如：
   - 当前可放置方块的复杂度
   - 历史消除率
   - 连续未消除的回合数

2. 可以为不同游戏模式设置不同的困难度曲线

3. 可以收集玩家数据，进一步调优阈值 